#!/bin/bash

NO_SET_CLIPBOARD=0

show_usage () {
	echo 'usage: termux-info [--no-set-clipboard]'
	echo 'Provides information about Termux, and the current system. Helpful for debugging.'
	exit 0

}

while [ $# -ge 1 ]; do
	case "$1" in
		--no-set-clipboard) NO_SET_CLIPBOARD="1"; shift;;
		-h | --help) show_usage;;
		*) break;;
	esac
done

if [ "$#" != "0" ]; then
	show_usage
fi

check_apk_update () {
    if ! command -v curl &> /dev/null; then
        echo "Warning: 'curl' not found. Install with 'pkg install curl' to enable APK update check."
        return
    fi

    if ! command -v jq &> /dev/null; then
        echo "Warning: 'jq' not found. Install with 'pkg install jq' to enable APK update check."
        return
    fi

    local TERMUX_SOURCE="${TERMUX_APP__APK_RELEASE:-$TERMUX_APK_RELEASE}"
    local CURRENT_VERSION="${TERMUX_VERSION}"
    local RELEASE_DATA
    local LATEST_VERSION=""
    local URL_API
    local DOWNLOAD_URL
    local SOURCE_NAME="${TERMUX_APK_RELEASE}"

    case "$TERMUX_SOURCE" in
        "GITHUB")
            URL_API="https://api.github.com/repos/termux/termux-app/releases/latest"
            DOWNLOAD_URL="https://github.com/termux/termux-app/releases/latest"
            ;;

        "F_DROID")
            URL_API="https://f-droid.org/api/v1/packages/com.termux"
            DOWNLOAD_URL="https://f-droid.org/en/packages/com.termux"
            ;;

        *)
            echo "Info: Termux APK Source ('$TERMUX_SOURCE') is unknown. Check skipped."
            return
            ;;
    esac

    if ! RELEASE_DATA=$(curl --fail -s "$URL_API"); then
        echo "# API URL Source: $URL_API"
        echo "[!] Failed to connect to the internet or fetch $SOURCE_NAME release data."
        return
    fi

    if [[ "$TERMUX_SOURCE" == "GITHUB" ]]; then
        LATEST_VERSION=$(jq -r '.tag_name' <<< "$RELEASE_DATA" | sed 's/^v//')
    elif [[ "$TERMUX_SOURCE" == "F_DROID" ]]; then
        # Find versionName matching suggestedVersionCode
        LATEST_VERSION=$(jq -r '. as $data | $data.packages[] | select(.versionCode == $data.suggestedVersionCode) | .versionName' <<< "$RELEASE_DATA")
    fi

    if [[ -z "$LATEST_VERSION" || "$LATEST_VERSION" == "null" ]]; then
        echo "Warning: Failed to get the latest version number from $SOURCE_NAME."
        return
    fi

    if [[ "$LATEST_VERSION" == "$CURRENT_VERSION" ]]; then
        echo "# API URL Source: $URL_API"
        echo "Termux APK version $CURRENT_VERSION from $SOURCE_NAME is up to date."
    else
        echo "# API URL Source: $URL_API"
        echo "[!]New version available ($SOURCE_NAME)"
        echo "Latest version: $LATEST_VERSION"
        echo "Current version: $CURRENT_VERSION"
        echo "Download from: $DOWNLOAD_URL"
    fi
}

updates() {
	local updatable

	if [ "$(id -u)" = "0" ]; then
		echo "Running as root. Cannot check package updates."
	else
		if [ "$TERMUX_APP_PACKAGE_MANAGER" = "apt" ]; then
			apt update >/dev/null 2>&1
			updatable=$(apt list --upgradable 2>/dev/null | tail -n +2)
		elif [ "$TERMUX_APP_PACKAGE_MANAGER" = "pacman" ]; then
			pacman -Sy >/dev/null 2>&1
			updatable=$(pacman -Qu)
		fi

		if [ -z "$updatable" ];then
			echo "All packages up to date"
		else
			echo "$updatable"
		fi
	fi
}

repo_subscriptions_apt() {
	local apt_dir="@TERMUX_PREFIX@/etc/apt"

	local filename source_entry repo_package sources_type
	for filename in "${apt_dir}"/sources.list{,.d/*}; do
		[[ -f "$filename" ]] || continue
		case "$filename" in
			*.sources) sources_type="deb822";;
			*.list)    sources_type="legacy";;
			*) continue;; # Not a valid source type, skip
		esac
		source_entry="$(<"$filename")"
		repo_package=$(dpkg -S "$filename" 2>/dev/null | cut -d : -f 1)

		local printf_format=""
		if [[ -n "$repo_package" ]]; then
			printf_format="# %s(%s) [%s]\n"
		else
			printf_format="# %s%s [%s]\n"
		fi

		# shellcheck disable=SC2059
		printf "${printf_format}" \
			"${repo_package}" \
			"${filename/$apt_dir\/}" \
			"${sources_type}"
		echo "$source_entry"
	done
}

repo_subscriptions_pacman() {
	local conf
	conf="@TERMUX_PREFIX@/etc/pacman.conf"

	if [[ -f $conf ]]; then
		echo "# $conf"
		for i in $(pacman-conf -l); do
			echo "[$i]"
			pacman-conf -r "$i"
		done
	else
		echo "$conf file not found"
	fi
}

# Setup TERMUX_APP_PACKAGE_MANAGER
# shellcheck source=/dev/null
source "@TERMUX_PREFIX@/bin/termux-setup-package-manager" || exit 1

case "${TERMUX__USER_ID:-}" in ''|*[!0-9]*|0[0-9]*) TERMUX__USER_ID=0;; esac
export TERMUX__USER_ID

output=""

if [ -n "${TERMUX_VERSION:-}" ]; then
# Application version is exported in Termux v0.107 or higher only.
output+="Termux Variables:
$(compgen -e TERMUX_ | while read -r v; do echo "${v}=${!v}"; done)
"
else
output+="Termux Variables:
unsupported
"
fi

output+="Termux APK Update Status:
$(check_apk_update)
"

output+="Packages CPU architecture:
$(
	if [ "$TERMUX_APP_PACKAGE_MANAGER" = "apt" ]; then
		dpkg --print-architecture
	elif [ "$TERMUX_APP_PACKAGE_MANAGER" = "pacman" ]; then
		pacman-conf | grep Architecture | sed 's/Architecture = //g'
	fi
)
Subscribed repositories:
$(
	if [ "$TERMUX_APP_PACKAGE_MANAGER" = "apt" ]; then
		repo_subscriptions_apt
	elif [ "$TERMUX_APP_PACKAGE_MANAGER" = "pacman" ]; then
		repo_subscriptions_pacman
	fi
)
Updatable packages:
$(updates)
termux-tools version:
@PACKAGE_VERSION@
Android version:
$(getprop ro.build.version.release)
Kernel build information:
$(uname -a)
Device manufacturer:
$(getprop ro.product.manufacturer)
Device model:
$(getprop ro.product.model)
Supported ABIs:
SUPPORTED_ABIS: $(getprop ro.product.cpu.abilist)
SUPPORTED_32_BIT_ABIS: $(getprop ro.product.cpu.abilist32)
SUPPORTED_64_BIT_ABIS: $(getprop ro.product.cpu.abilist64)
LD Variables:
LD_LIBRARY_PATH=$LD_LIBRARY_PATH
LD_PRELOAD=$LD_PRELOAD"
# Escape '\$[](){}|^.?+*' with backslashes for regex
escaped_package_name="$(echo -n "@TERMUX_APP_PACKAGE@" | sed -zE -e 's/[][\.|$(){}?+*^]/\\&/g')"
show_version_code=""
sdk_version="$(getprop ro.build.version.sdk || :)"
if [[ "$sdk_version" =~ ^[0-9]+$ ]] && [ "$sdk_version" -ge "26" ]; then
  show_version_code="--show-versioncode"
fi
TERMUX_PLUGINS="$(pm list packages --user "$TERMUX__USER_ID" $show_version_code 2>&1 </dev/null | grep -E "^package:$escaped_package_name\.[a-zA-Z]" | cut -d ":" -f 2- | grep -vE "^$escaped_package_name\.tapm\.[a-zA-Z]")"
if [ -n "${TERMUX_PLUGINS:-}" ]; then
	output+="$(printf "\nInstalled termux plugins:\n${TERMUX_PLUGINS}\n")"
fi
echo "$output"

if [ "$NO_SET_CLIPBOARD" != "1" ] && [ -n "$(command -v termux-clipboard-set)" ]; then
	# Copy to clipboard (requires termux-api)
	# use timeout in case termux-api is installed but the termux:api app is missing
	echo "$output" | timeout 3 termux-clipboard-set 2>/dev/null
	timeout 3 termux-toast "Information has been copied to the clipboard" 2>/dev/null
fi

exit 0
